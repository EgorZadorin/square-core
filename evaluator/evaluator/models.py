from datetime import datetime
from enum import Enum
from typing import Dict, List, Optional

from pydantic import BaseModel, Field, validator

from evaluator.mongo.mongo_model import MongoModel
from evaluator.mongo.py_object_id import PyObjectId


class Example(MongoModel):
    id: Optional[PyObjectId] = Field(
        None, description="Identifier generated by mongoDB"
    )
    name: str = Field(..., description="Test name.")
    something: str = Field(..., description="Something. Something.")

    class Config:
        schema_extra = {
            "example": {
                "name": "My Example",
                "something": "Something something.",
            }
        }


class ReferenceAnswer(BaseModel):
    answer_start: List[int] = Field(...)
    text: List[str] = Field(...)


class PredictionAnswer(BaseModel):
    text: str = Field(...)
    no_answer_probability: float = Field(...)


class Prediction(BaseModel):
    id: str = Field(...)
    context: str = Field(...)
    question: str = Field(...)
    reference_answers: Optional[ReferenceAnswer] = Field(...)
    prediction: Optional[PredictionAnswer] = Field(...)


class Metric(BaseModel):
    metric_last_updated_at: datetime = Field(...)
    metric_calculation_time: float = Field(
        ..., description="Calculation time in seconds"
    )
    results: dict = Field(...)


class DatasetResult(MongoModel):
    _id: Optional[PyObjectId] = Field(
        None, description="Identifier generated by mongoDB"
    )
    skill_id: PyObjectId = Field(
        ..., description="Identifier of the skill that generated the prediction."
    )
    dataset_name: str = Field(..., description="Name of the dataset")
    predictions_last_updated_at: datetime = Field()
    predictions_calculation_time: float = Field(
        ..., description="Calculation time in seconds"
    )
    predictions: List[Prediction] = Field(
        ...,
        description="Both the reference data and the prediction for each entry of the dataset",
    )
    metrics: Optional[dict[str, Metric]] = Field(...)
